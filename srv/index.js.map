{"version":3,"file":"index.js","sources":["../routers/db-3fc2d531.js","../routers/activities.js","../routers/products.js","../routers/report.js","../index.ts"],"sourcesContent":["import postgres from 'postgres';\nimport debug from 'debug';\n\nlet missingFields; function $required(name, value) {\r\n    if (typeof value === 'undefined')\r\n        missingFields.push(name);\r\n    return value;\r\n} function $wrapper(fn, decoder) {\r\n    return async function expressBuilderMiddleware(req, res, next) {\r\n        var _a;\r\n        try {\r\n            missingFields = [];\r\n            const args = decoder((req.method === 'GET' || req.method === 'HEAD') ? {} : req.body, req.query, req.params);\r\n            if (missingFields.length)\r\n                throw {\r\n                    code: 400,\r\n                    type: 'MISSING_FIELDS_ERROR',\r\n                    message: `${missingFields.length} ${missingFields.length ? 'field is' : 'fields are'} missing: ${missingFields.join(', ')}`,\r\n                    fields: missingFields\r\n                };\r\n            try {\r\n                let data = typeof fn === 'function' ? fn.apply(req.session || (req.session = {}), args) : fn;\r\n                if (!(data instanceof Promise))\r\n                    data = Promise.resolve(data);\r\n                data = await data;\r\n                if (data === undefined || req.method === 'HEAD')\r\n                    res.status(204).end();\r\n                else\r\n                    res.status(200).json({ data });\r\n            }\r\n            catch (err) {\r\n                if (err instanceof TypeError\r\n                    || err instanceof SyntaxError\r\n                    || err instanceof EvalError)\r\n                    throw err;\r\n                if (typeof err !== 'object' || !err)\r\n                    err = { type: 'INVALID_INTERNAL_ERROR', unexpected: err };\r\n                else if (err instanceof Error)\r\n                    err = { ...err, status: err.status, code: err.code || ((_a = Object.getPrototypeOf(err)) === null || _a === void 0 ? void 0 : _a.name), message: err.message };\r\n                throw err;\r\n            }\r\n        }\r\n        catch (err) {\r\n            if (err instanceof Error)\r\n                next(err);\r\n            else {\r\n                const { status = 500, code = 'UNKNOWN_ERROR', message = 'Internal server error', ...data } = err || {};\r\n                res.status(status).json({ error: { code, message, ...data } });\r\n            }\r\n        }\r\n    };\r\n}\n\nconst log = debug('postgres:query');\r\nconst sql = postgres({\r\n    database: 'surfor',\r\n    debug: (_, q) => log('query: %s', q)\r\n});\n\nexport { $wrapper as $, $required as a, sql as s };\n//# sourceMappingURL=db-3fc2d531.js.map\n","import { s as sql, $ as $wrapper } from './db-3fc2d531.js';\nimport { Router } from 'express';\nimport 'postgres';\nimport 'debug';\n\nasync function activities() {\r\n    return sql `SELECT * FROM activity;`;\r\n}\n\nconst $router = Router({ caseSensitive: true });\n\n$router.all(\"/activities\", $wrapper(activities, () => []));\n\nexport default $router;\n//# sourceMappingURL=activities.js.map\n","import { s as sql, $ as $wrapper } from './db-3fc2d531.js';\nimport { Router } from 'express';\nimport 'postgres';\nimport 'debug';\n\nasync function products() {\r\n    const [{ products: reportables }, { products: consumables }] = await sql `SELECT array_agg(json_build_object('id',product_id,'name',name)) AS products FROM product GROUP BY is_consumable ORDER BY is_consumable ASC;`;\r\n    return ({\r\n        consumables,\r\n        reportables\r\n    });\r\n}\n\nconst $router = Router({ caseSensitive: true });\n\n$router.all(\"/products\", $wrapper(products, () => []));\n\nexport default $router;\n//# sourceMappingURL=products.js.map\n","import { s as sql, $ as $wrapper, a as $required } from './db-3fc2d531.js';\nimport { Router } from 'express';\nimport 'postgres';\nimport 'debug';\n\nasync function report({ activityId: activity_id, deviceId: device_uuid, position, products, activityStartedAt: activity_started_at, activityEndedAt: activity_ended_at }) {\r\n    await sql.begin(async (sql) => {\r\n        const [{ report_id } = { report_id: null }] = await sql `INSERT INTO report ${sql({\r\n            activity_id,\r\n            device_uuid,\r\n            position: [position],\r\n            activity_started_at,\r\n            activity_ended_at\r\n        })} RETURNING report_id`;\r\n        await sql `INSERT INTO report_product ${sql(products.map((productId) => ({\r\n            product_id: productId,\r\n            report_id\r\n        })))}`;\r\n    });\r\n}\r\nasync function statistics() {\r\n    const [[report], products] = await sql.begin(sql => [\r\n        sql `SELECT\n      COUNT(report_id)::integer AS reports_count,\n      COUNT(DISTINCT device_uuid)::integer AS users_count,\n      EXTRACT(epoch FROM AVG(activity_ended_at - activity_started_at)) * 1000 AS report_avg_duration\n    FROM report`,\r\n        sql `\n    SELECT\n      RP.product_id AS id,\n      P.name,\n      P.is_consumable,\n      COUNT(*)::integer AS count\n    FROM report_product RP\n    INNER JOIN product P ON P.product_id = RP.product_id\n    GROUP BY RP.product_id, P.name, P.is_consumable\n    ORDER BY count DESC`\r\n    ]);\r\n    return { ...report, products };\r\n}\n\nconst $router = Router({ caseSensitive: true });\n\n$router.all(\"/report\", $wrapper(report, obj => [$required(\"$0\", obj)]));\n\n$router.all(\"/statistics\", $wrapper(statistics, () => []));\n\nexport default $router;\n//# sourceMappingURL=report.js.map\n","import { resolve } from 'path';\nimport cors from 'cors';\nimport express from 'express';\nimport activities from './routers/activities';\nimport products from './routers/products';\nimport report from './routers/report';\n\nconst app = express();\n\nconst dist = resolve(__dirname, '../../dist'); // Resolved from server/dist/index.js\n\napp.use(express.static(dist));\n\nconst apiErrorHandler: express.ErrorRequestHandler = (error, req, res, next) => res.status(500).json({\n  error: {\n    code: 'INTERNAL_SERVER_ERROR',\n    message: 'An internal server occured: ' + (error && (error.message || error)),\n    error\n  }\n});\n\nconst notFoundHandler: express.RequestHandler = (req, res) => res.status(404).json({\n  error: {\n    code: 'NOT_FOUND',\n    message: 'Route not found: ' + req.path,\n    route: req.path\n  }\n});\n\napp.use('/api',\n  cors({ origin: 'http://localhost:3000', credentials: true }),\n  express.json(),\n  products,\n  activities,\n  report,\n  apiErrorHandler,\n  notFoundHandler\n);\n\napp.use((_, res) => res.sendFile('index.html', { root: dist }));\n\nconst PORT = +(process.env.PORT || 4000);\napp.listen(PORT, () => console.info('Server ready. http://localhost:%d/', PORT));\n"],"names":["debug","postgres","Router","$router","express","resolve","cors","products","activities","report"],"mappings":"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"}